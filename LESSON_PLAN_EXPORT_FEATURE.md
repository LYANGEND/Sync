# Lesson Plan Export Feature - PDF & Word

## Overview
Teachers can now export AI-generated lesson plans, quizzes, and emails to PDF or Word format for offline editing, printing, and sharing.

## Features

### Supported Export Formats
- **PDF** - Professional, print-ready documents
- **Word (DOCX)** - Fully editable Microsoft Word documents

### Supported Content Types
- ✅ Lesson Plans
- ✅ Quizzes
- ✅ Email Drafts
- ✅ Chat Conversations

## Backend Implementation

### New Dependencies
```json
{
  "docx": "^8.x",      // Word document generation
  "marked": "^12.x"    // Markdown parsing
}
```

Existing:
- `pdfkit` - PDF generation (already installed)

### New Service: `documentExportService.ts`

Located at: `backend/src/services/documentExportService.ts`

#### Functions:

**PDF Generation:**
- `generateLessonPlanPDF(content, metadata)` - Creates formatted PDF
- `generateQuizPDF(content, metadata)` - Quiz-specific PDF
- `generateEmailPDF(content, metadata)` - Email draft PDF

**Word Generation:**
- `generateLessonPlanWord(content, metadata)` - Creates DOCX file
- `generateQuizWord(content, metadata)` - Quiz-specific DOCX
- Word documents are fully editable in Microsoft Word, Google Docs, LibreOffice

#### Features:
- Markdown to formatted document conversion
- Professional styling and formatting
- Headers, footers, and page numbers
- Metadata inclusion (teacher name, school, date)
- Section-based structure
- Bullet points and numbered lists
- Proper spacing and typography

### New API Endpoints

#### Export to PDF
```
GET /api/v1/teacher-assistant/conversations/:id/export/pdf
```

**Response:**
- Content-Type: `application/pdf`
- Content-Disposition: `attachment; filename="Lesson_Plan_Topic.pdf"`
- Binary PDF data

#### Export to Word
```
GET /api/v1/teacher-assistant/conversations/:id/export/word
```

**Response:**
- Content-Type: `application/vnd.openxmlformats-officedocument.wordprocessingml.document`
- Content-Disposition: `attachment; filename="Lesson_Plan_Topic.docx"`
- Binary DOCX data

### Controller Functions

Added to `teacherAssistantController.ts`:
- `exportConversationPDF(req, res)` - Handles PDF export
- `exportConversationWord(req, res)` - Handles Word export

Both functions:
1. Verify user owns the conversation
2. Retrieve conversation with metadata
3. Extract AI-generated content
4. Generate formatted document
5. Send as downloadable file

## Document Structure

### PDF Format

**Header Section:**
- Document title (Lesson Plan / Quiz / Email)
- Subject, Grade Level, Topic
- Duration
- Teacher name (if available)
- School name (if available)
- Horizontal separator line

**Content Section:**
- Hierarchical headings (H1, H2, H3)
- Body text with proper line spacing
- Bullet points and lists
- Page breaks when needed

**Footer Section:**
- Page numbers (Page X of Y)
- "Generated by Sync AI Teaching Assistant"

**Styling:**
- Font: Helvetica
- Title: 20pt bold
- H1: 16pt bold, dark blue
- H2: 14pt bold, medium gray
- H3: 12pt bold, light gray
- Body: 11pt regular
- Margins: 50pt all sides
- Paper: A4

### Word Format

**Document Structure:**
- Title paragraph (centered, large)
- Metadata table
- Horizontal separator
- Content sections with proper headings
- Footer with generation info

**Styling:**
- Heading 1, 2, 3 styles
- Bullet lists
- Proper paragraph spacing
- Professional formatting
- Fully editable

**Benefits:**
- Teachers can modify content
- Add school-specific information
- Adjust formatting
- Insert images or diagrams
- Share with colleagues

## Frontend Integration Guide

### Example: Download Button Component

```typescript
// In your lesson plan view component
const handleExportPDF = async (conversationId: string) => {
  try {
    const response = await fetch(
      `/api/v1/teacher-assistant/conversations/${conversationId}/export/pdf`,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'x-tenant-id': tenantId,
        },
      }
    );

    if (!response.ok) throw new Error('Export failed');

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `lesson-plan-${conversationId}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  } catch (error) {
    console.error('Export error:', error);
    alert('Failed to export PDF');
  }
};

const handleExportWord = async (conversationId: string) => {
  try {
    const response = await fetch(
      `/api/v1/teacher-assistant/conversations/${conversationId}/export/word`,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'x-tenant-id': tenantId,
        },
      }
    );

    if (!response.ok) throw new Error('Export failed');

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `lesson-plan-${conversationId}.docx`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  } catch (error) {
    console.error('Export error:', error);
    alert('Failed to export Word document');
  }
};

// UI Buttons
<div className="export-buttons">
  <button onClick={() => handleExportPDF(conversationId)}>
    <FileDownloadIcon /> Export PDF
  </button>
  <button onClick={() => handleExportWord(conversationId)}>
    <FileDownloadIcon /> Export Word
  </button>
</div>
```

### Recommended UI Placement

1. **Lesson Plan View Page**
   - Add export buttons next to the lesson plan title
   - Show both PDF and Word options

2. **Conversations List**
   - Add export icon/button for each conversation
   - Dropdown menu with PDF/Word options

3. **After Generation**
   - Show export options immediately after generating content
   - "Download PDF" and "Download Word" buttons

4. **Bulk Export** (Future Enhancement)
   - Select multiple lesson plans
   - Export all as ZIP file

### UI/UX Recommendations

**Button Design:**
```tsx
// Primary export button
<Button variant="outlined" startIcon={<PictureAsPdfIcon />}>
  Export PDF
</Button>

// Secondary export button
<Button variant="outlined" startIcon={<DescriptionIcon />}>
  Export Word
</Button>

// Dropdown menu
<Menu>
  <MenuItem onClick={handleExportPDF}>
    <PictureAsPdfIcon /> Download as PDF
  </MenuItem>
  <MenuItem onClick={handleExportWord}>
    <DescriptionIcon /> Download as Word
  </MenuItem>
</Menu>
```

**Loading States:**
```tsx
const [exporting, setExporting] = useState(false);

const handleExport = async (format: 'pdf' | 'word') => {
  setExporting(true);
  try {
    // ... export logic
  } finally {
    setExporting(false);
  }
};

<Button disabled={exporting}>
  {exporting ? <CircularProgress size={20} /> : <FileDownloadIcon />}
  {exporting ? 'Exporting...' : 'Export PDF'}
</Button>
```

**Success Feedback:**
```tsx
// Show toast notification
toast.success('Lesson plan exported successfully!');

// Or snackbar
<Snackbar 
  open={showSuccess} 
  message="Document downloaded successfully"
  autoHideDuration={3000}
/>
```

## Use Cases

### 1. Offline Editing
Teachers can download Word documents and:
- Add school-specific details
- Customize activities
- Insert images or diagrams
- Adjust timing
- Add personal notes

### 2. Printing
PDF format provides:
- Professional appearance
- Consistent formatting
- Ready for classroom use
- Easy to share with administrators

### 3. Archiving
Teachers can:
- Save lesson plans to personal folders
- Build a lesson plan library
- Share with colleagues
- Submit for evaluations

### 4. Collaboration
- Email lesson plans to team members
- Share via Google Drive/OneDrive
- Collaborative editing in Word
- Version control

## Testing

### Manual Testing Steps

1. **Generate a lesson plan**
   ```bash
   POST /api/v1/teacher-assistant/lesson-plan/generate
   {
     "subject": "Mathematics",
     "topic": "Fractions",
     "gradeLevel": 5,
     "duration": 60
   }
   ```

2. **Get conversation ID from response**

3. **Export to PDF**
   ```bash
   GET /api/v1/teacher-assistant/conversations/{id}/export/pdf
   ```
   - Verify PDF downloads
   - Open in PDF reader
   - Check formatting and content

4. **Export to Word**
   ```bash
   GET /api/v1/teacher-assistant/conversations/{id}/export/word
   ```
   - Verify DOCX downloads
   - Open in Microsoft Word
   - Verify editability
   - Check formatting

5. **Test different content types**
   - Lesson plans
   - Quizzes
   - Email drafts

### Automated Testing

```typescript
describe('Document Export', () => {
  it('should export lesson plan as PDF', async () => {
    const response = await request(app)
      .get(`/api/v1/teacher-assistant/conversations/${conversationId}/export/pdf`)
      .set('Authorization', `Bearer ${token}`)
      .set('x-tenant-id', tenantId);

    expect(response.status).toBe(200);
    expect(response.headers['content-type']).toBe('application/pdf');
    expect(response.body).toBeInstanceOf(Buffer);
  });

  it('should export lesson plan as Word', async () => {
    const response = await request(app)
      .get(`/api/v1/teacher-assistant/conversations/${conversationId}/export/word`)
      .set('Authorization', `Bearer ${token}`)
      .set('x-tenant-id', tenantId);

    expect(response.status).toBe(200);
    expect(response.headers['content-type']).toContain('wordprocessingml');
    expect(response.body).toBeInstanceOf(Buffer);
  });
});
```

## Error Handling

### Common Errors

1. **Conversation not found (404)**
   ```json
   { "error": "Conversation not found" }
   ```

2. **No content to export (404)**
   ```json
   { "error": "No content to export" }
   ```

3. **Export failed (500)**
   ```json
   { "error": "Failed to export PDF" }
   ```

### Frontend Error Handling

```typescript
try {
  await handleExport('pdf');
} catch (error) {
  if (error.status === 404) {
    toast.error('Lesson plan not found');
  } else if (error.status === 500) {
    toast.error('Export failed. Please try again.');
  } else {
    toast.error('An unexpected error occurred');
  }
}
```

## Performance Considerations

- PDF generation: ~100-500ms
- Word generation: ~200-800ms
- File sizes: 50KB - 500KB typically
- No server-side caching needed (generated on-demand)

## Security

- ✅ Authentication required
- ✅ Tenant isolation enforced
- ✅ User can only export their own conversations
- ✅ No sensitive data in filenames
- ✅ Content sanitization in markdown parser

## Future Enhancements

1. **Custom Templates**
   - School-branded headers/footers
   - Custom color schemes
   - Logo insertion

2. **Batch Export**
   - Export multiple lesson plans
   - ZIP file download
   - Folder organization

3. **Email Integration**
   - Email lesson plan directly
   - Share with colleagues
   - Send to parents

4. **Cloud Storage**
   - Save to Google Drive
   - Save to OneDrive
   - Automatic backup

5. **Print Preview**
   - Preview before download
   - Adjust formatting
   - Page layout options

6. **Version History**
   - Track document versions
   - Compare changes
   - Restore previous versions

## Installation

Already installed! The feature is ready to use. Just add the frontend UI components.

## Summary

The export feature provides teachers with professional, editable documents they can use offline, modify, print, and share. PDF format ensures consistent appearance, while Word format enables full customization. This significantly enhances the practical value of AI-generated lesson plans.
