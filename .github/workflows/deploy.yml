name: CI/CD Pipeline

on:
  push:
    branches: [ power ]
  pull_request:
    branches: [ power ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: lyangend/sync

jobs:
  # Run tests and linting before building
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run backend type check
        working-directory: ./backend
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend type check
        working-directory: ./frontend
        run: npx tsc --noEmit
        continue-on-error: true

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:buildcache,mode=max
          build-args: |
            NODE_ENV=production
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:buildcache,mode=max

      - name: Extract metadata for Website
        id: meta-website
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/website
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Website image
        uses: docker/build-push-action@v5
        with:
          context: ./website
          push: true
          tags: ${{ steps.meta-website.outputs.tags }}
          labels: ${{ steps.meta-website.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/website:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/website:buildcache,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/power'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure nginx directory exists on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            mkdir -p ~/app-mt/nginx

      - name: Copy configuration files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "docker-compose.prod.yml,nginx-system.conf"
          target: "~/app-mt"
          strip_components: 0

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ~/app-mt
            
            # Get Docker bridge gateway IP (for connecting to host PostgreSQL)
            DOCKER_HOST_IP=$(ip -4 addr show docker0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}' || echo "172.17.0.1")
            echo "üìå Docker host IP: $DOCKER_HOST_IP"
            
            # Create .env file with secure permissions
            cat > .env << EOF
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=muti_tenant
            POSTGRES_HOST=$DOCKER_HOST_IP
            POSTGRES_PORT=${{ secrets.POSTGRES_PORT || '5432' }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
            BASE_DOMAINS=${{ secrets.BASE_DOMAINS }}
            AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }}
            AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }}
            AZURE_OPENAI_API_VERSION=2024-12-01-preview
            AZURE_OPENAI_DEPLOYMENT=gpt-4o
            LENCO_API_KEY=${{ secrets.LENCO_API_KEY }}
            LENCO_WEBHOOK_SECRET=${{ secrets.LENCO_WEBHOOK_SECRET }}
            NODE_ENV=production
            EOF
            chmod 600 .env
            
            # Debug: show PostgreSQL connection info (without password)
            echo "üìå PostgreSQL connection: $DOCKER_HOST_IP:${{ secrets.POSTGRES_PORT || '5432' }}"
            
            # Login to GHCR
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull latest images (force pull)
            docker-compose -f docker-compose.prod.yml pull --ignore-pull-failures
            
            # Stop and remove containers (only multi-tenant ones)
            docker-compose -f docker-compose.prod.yml down --remove-orphans
            
            # Clean up any orphaned multi-tenant containers
            docker ps -a --filter "name=sync_mt" --format "{{.ID}}" | xargs -r docker rm -f || true
            
            # Test database connectivity before running migrations
            echo "üîç Testing database connectivity..."
            docker-compose -f docker-compose.prod.yml run --rm backend sh -c 'echo "SELECT 1" | npx prisma db execute --stdin' || {
              echo "‚ö†Ô∏è Cannot connect to database. Checking if PostgreSQL is reachable..."
              docker-compose -f docker-compose.prod.yml run --rm backend sh -c "nc -zv $DOCKER_HOST_IP 5432" 2>&1 || true
              echo "üí° Make sure PostgreSQL is running and accepts connections from Docker"
              echo "üí° Check: sudo -u postgres psql -c \"ALTER SYSTEM SET listen_addresses = '*';\""
              echo "üí° Check pg_hba.conf allows: host all all 172.17.0.0/16 md5"
            }
            
            # Run migrations on host PostgreSQL
            echo "üöÄ Running database migrations..."
            docker-compose -f docker-compose.prod.yml run --rm backend npx prisma migrate deploy || {
              echo "‚ùå Migration failed!"
              docker logs sync_mt_backend --tail=50 2>/dev/null || echo "Backend container not running yet"
              exit 1
            }
            
            # Start all services with latest images (force recreate)
            docker-compose -f docker-compose.prod.yml up -d --force-recreate
            
            # Wait for services to be healthy
            echo "‚è≥ Waiting for services to be ready..."
            
            # Wait for backend (multi-tenant runs on port 5080)
            for i in {1..30}; do
              if docker exec sync_mt_backend wget -q --spider http://localhost:3000/health 2>/dev/null; then
                echo "‚úÖ Backend is ready!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "‚ö†Ô∏è Backend health check timeout (checking logs...)"
                docker logs sync_mt_backend --tail=50
                exit 1
              fi
              sleep 3
            done
            
            # Wait for frontend
            for i in {1..20}; do
              if docker exec sync_mt_frontend wget -q --spider http://localhost:80/ 2>/dev/null; then
                echo "‚úÖ Frontend is ready!"
                break
              fi
              if [ $i -eq 20 ]; then
                echo "‚ö†Ô∏è Frontend health check timeout (checking logs...)"
                docker logs sync_mt_frontend --tail=50
                exit 1
              fi
              sleep 2
            done
            
            # Configure system nginx for multi-tenant
            echo "üîß Configuring system nginx for multi-tenant..."
            
            # Only update nginx config if it has changed
            if ! sudo diff -q ~/app-mt/nginx-system.conf /etc/nginx/sites-available/sync-mt-base 2>/dev/null; then
              echo "üìù Multi-tenant nginx config changed, updating..."
              # Backup the base config (without SSL)
              sudo cp ~/app-mt/nginx-system.conf /etc/nginx/sites-available/sync-mt-base
              
              # If SSL config exists, preserve it; otherwise use base
              if [ -f /etc/nginx/sites-available/sync-mt ] && grep -q "ssl_certificate" /etc/nginx/sites-available/sync-mt; then
                echo "‚úÖ SSL config detected, preserving..."
                # Keep the existing config with SSL
              else
                echo "üìã No SSL config, using base config..."
                sudo cp ~/app-mt/nginx-system.conf /etc/nginx/sites-available/sync-mt
              fi
              
              sudo ln -sf /etc/nginx/sites-available/sync-mt /etc/nginx/sites-enabled/sync-mt
              
              # Test nginx configuration
              sudo nginx -t || {
                echo "‚ùå nginx configuration error"
                exit 1
              }
              
              # Reload nginx
              sudo systemctl reload nginx
            else
              echo "‚úÖ Multi-tenant nginx config unchanged, skipping update"
            fi
            
            # Show deployment status
            echo "üìä Multi-Tenant Deployment Status:"
            docker-compose -f docker-compose.prod.yml ps
            
            # Test the application via multi-tenant port
            echo "üß™ Testing multi-tenant application..."
            if curl -s -f http://localhost:5080/health > /dev/null 2>&1; then
              echo "‚úÖ Multi-tenant application is accessible on port 5080!"
            else
              echo "‚ö†Ô∏è Multi-tenant application might not be accessible via nginx"
            fi
            
            # Clean up old Docker images to save space
            echo "üßπ Cleaning up old Docker images..."
            
            # Remove dangling images
            docker image prune -f
            
            # Remove old sync images (keep only latest 2)
            echo "Removing old sync/backend images..."
            docker images ghcr.io/lyangend/sync/backend --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +3 | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            
            echo "Removing old sync/frontend images..."
            docker images ghcr.io/lyangend/sync/frontend --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +3 | awk '{print $1}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # Show disk space saved
            echo "‚úÖ Cleanup complete"
            df -h / | tail -1
            
            # Create database backup (optional)
            echo "üíæ Creating multi-tenant database backup..."
            BACKUP_FILE="backup_mt_$(date +%Y%m%d_%H%M%S).sql"
            PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }} pg_dump -h localhost -U ${{ secrets.POSTGRES_USER }} muti_tenant > "$BACKUP_FILE" 2>/dev/null && \
            echo "‚úÖ Backup created: $BACKUP_FILE" || \
            echo "‚ö†Ô∏è Backup skipped or failed"
            
            echo "üéâ Multi-Tenant Deployment completed successfully!"